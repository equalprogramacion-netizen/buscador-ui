<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de B√∫squeda</title>

  <!-- =====================
       FRAMEWORKS Y ESTILOS
       ===================== -->
  <!-- Bootstrap: librer√≠a CSS para dise√±o responsivo y componentes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet: para visualizaci√≥n de mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- MarkerCluster: agrupaci√≥n de puntos para reducir carga -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <!-- DataTables: mejora el manejo de tablas (paginaci√≥n, b√∫squeda, etc.) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <!-- Tema unificado -->
  <link rel="stylesheet" href="/static/hub-theme.css" />

  <!-- =====================
       ESTILOS PERSONALIZADOS
       ===================== -->
  <style>
    :root {
      --primary: {{ PRIMARY }};
      --accent:  {{ ACCENT }};
      --ink:     {{ INK }};
      --muted:   {{ MUTED }};
      --bg:      {{ BG }};
      --card:    {{ CARD }};
      --border:  {{ BORDER }};
      --logo-radius: {{ LOGO_RADIUS }};
    }
  </style>
</head>

<body>
<div class="wrap animate-enter">

  <!-- ==========================
       ENCABEZADO DE RESULTADOS
       ========================== -->
  <h3 class="mb-4">
    Resultados de b√∫squeda para:
    <strong>{{ palabra }}</strong>
    <strong>{{ columna if columna != '__todas__' else 'todas las columnas' }}</strong>
  </h3>

  <!-- ==============================
       VERIFICACI√ìN DE RESULTADOS
       ============================== -->
  {% if resultados %}
    <!-- Botones de exportaci√≥n y volver -->
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <a href="/exportar_csv" class="btn-main">üìÅ CSV (todo)</a>
      <a href="/exportar_excel" class="btn-outline">üìä Excel (todo)</a>
      <a href="/" class="btn-outline">üîç Nueva b√∫squeda</a>
    </div>

    <!-- ===============================
         TABLA DE RESULTADOS
         =============================== -->
    <div class="table-wrapper mb-4">
      <table id="tablaResultados" class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            {% for col in columnas_mostrar %}
              <th>{{ col }}</th>
            {% endfor %}
            {% if 'Latitud_decimal' not in columnas_mostrar %}
              <th>Latitud (mapa)</th>
            {% endif %}
            {% if 'Longitud_decimal' not in columnas_mostrar %}
              <th>Longitud (mapa)</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for fila in resultados %}
            <tr>
              {% for col in columnas_mostrar %}
                <td>{{ fila.get(col, 'No disponible') or 'No disponible' }}</td>
              {% endfor %}
              {% if 'Latitud_decimal' not in columnas_mostrar %}
                <td>{{ fila.get('Latitud_mapa', 'No disponible') or 'No disponible' }}</td>
              {% endif %}
              {% if 'Longitud_decimal' not in columnas_mostrar %}
                <td>{{ fila.get('Longitud_mapa', 'No disponible') or 'No disponible' }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ======================
         VISUALIZACI√ìN EN MAPA
         ====================== -->
    {% if resultados|length > 0 %}
      <h4 id="seccion-mapa" class="mt-5">Visualizaci√≥n en Mapa</h4>
      <div id="map" class="mb-5"></div>
    {% endif %}

  {% else %}
    <!-- Mensaje cuando no se encuentran resultados -->
        <div class="table-wrapper" style="background:#1d273d">
          <div class="alert alert-warning" style="margin:0">No se encontraron resultados.</div>
        </div>
        <div class="mt-3"><a href="/" class="btn-outline">üîç Nueva b√∫squeda</a></div>
  {% endif %}
</div>

<!-- ======================
     BOTONES FLOTANTES
     ====================== -->
<button id="btnSubir" class="floating-btn" onclick="subirPagina()" title="Subir">‚Üë</button>
<button id="btnMapa" class="floating-btn" onclick="irAlMapa()" title="Ir al mapa">üó∫Ô∏è</button>
<div class="footer">Tema unificado ¬∑ Hub Biotico</div>

<!-- ======================
     LIBRER√çAS JAVASCRIPT
     ====================== -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- ======================
     FUNCIONALIDAD JS
     ====================== -->
<script>

  $(document).ready(function () {
    $('#tablaResultados').DataTable({
      deferRender: true,
      scrollX: true,
      responsive: true,
      pageLength: 10,
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
      }
    });
  });
  
  // Inicializar mapa con Leaflet
  const mapEl = document.getElementById('map');
  console.log('[Mapa] Inicializando. Dimensiones iniciales:', mapEl ? mapEl.offsetWidth + 'x' + mapEl.offsetHeight : 'sin elemento');
  const map = L.map('map');
  map.setView([4.5, -74.1], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Agregar marcadores con informaci√≥n desde backend
  const puntos = {{ coordenadas | default([]) | tojson }};
  // Crear grupo de clusters (solo si hay > 100 puntos, si no se dejan individuales)
  const clusterGroup = L.markerClusterGroup({
    iconCreateFunction: function (cluster) {
      const count = cluster.getChildCount();
      const formatted = count.toLocaleString('es-ES');
      let sizeClass = 'cluster-small';
      if (count > 30) sizeClass = 'cluster-large';
      if (count > 100) sizeClass = 'cluster-xlarge';
      else if (count > 10 && count <= 30) sizeClass = 'cluster-medium';
      return L.divIcon({
        html: `<div tabindex="0" role="button" aria-label="Cluster con ${formatted} puntos"><span>${formatted}</span></div>`,
        className: `marker-cluster ${sizeClass}`,
        iconSize: L.point(40, 40) // dimensiones finales se ajustan via CSS por clase
      });
    }
  });

  puntos.forEach(punto => {
    const lat = parseFloat(punto.lat);
    const lon = parseFloat(punto.lon);
    if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
      const nombreCientifico = punto.Nombre_cientifico || 'No disponible';
      const nombreComun = punto.Nombre_comun || 'No disponible';
      const codigoMuestra = punto.Codigo_de_muestra || 'No disponible';
      const proyecto = punto.Proyecto || 'No disponible';
      const fecha = punto.Fecha_de_colecta || 'No disponible';
      const marker = L.marker([lat, lon]).bindPopup(
        `<strong>Nombre cient√≠fico:</strong> ${nombreCientifico}<br>
         <strong>Nombre com√∫n:</strong> ${nombreComun}<br>
         <strong>C√≥digo muestra:</strong> ${codigoMuestra}<br>
         <strong>Proyecto:</strong> ${proyecto}<br>
         <strong>Fecha:</strong> ${fecha}`
      );
      clusterGroup.addLayer(marker);
    }
  });

  if (puntos.length > 0) {
    map.addLayer(clusterGroup);
    try { map.fitBounds(clusterGroup.getBounds().pad(0.15)); } catch (e) { console.warn('[Mapa] fitBounds fallo', e); }
  }
  // Invalidate en varios intervalos para asegurar render tras layout / fonts
  [100, 300, 800].forEach(t => setTimeout(() => { try { console.log('[Mapa] invalidateSize en', t); map.invalidateSize(); } catch(e) {} }, t));
  // Invalidate al evento draw de DataTables (redimension scrollX)
  $('#tablaResultados').on('draw.dt', function(){ setTimeout(()=>{ try { console.log('[Mapa] invalidateSize tras draw.dt'); map.invalidateSize(); } catch(e){} },150); });
  // Resize listener por cambios de ventana
  window.addEventListener('resize', () => { try { map.invalidateSize(); } catch(e){} });
  // Fallback si altura < 200
  setTimeout(()=>{
    if (mapEl && mapEl.offsetHeight < 200) {
      console.warn('[Mapa] Altura baja detectada, forzando estilo.');
      mapEl.style.height='480px';
      try { map.invalidateSize(); } catch(e){}
    }
  }, 900);

  // Estilos de clusters ya manejados en hub-theme.css

  // Mostrar botones flotantes al hacer scroll
  window.onscroll = function () {
    const btnSubir = document.getElementById("btnSubir");
    const btnMapa = document.getElementById("btnMapa");
    if (window.scrollY > 200) {
      btnSubir.style.display = "block";
      btnMapa.style.display = "block";
    } else {
      btnSubir.style.display = "none";
      btnMapa.style.display = "none";
    }
  };

  // Funci√≥n para subir al inicio de la p√°gina
  function subirPagina() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Funci√≥n para navegar al mapa
  function irAlMapa() {
    const mapa = document.getElementById("seccion-mapa");
    if (mapa) {
      mapa.scrollIntoView({ behavior: 'smooth' });
    }
  }

  // Se elimin√≥ la exportaci√≥n cliente que solo tomaba filas visibles.
  // Ahora el enlace /exportar_excel usa el backend para generar el libro completo.
</script>
</body>
</html>
